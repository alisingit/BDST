## **Цель лабораторной работы**

Построить витрины данных (Data Marts, DM) на основе детального слоя DDS, полученного в ЛР2, реализовать ETL‑процессы для формирования витрин в Apache Airflow, развернуть сервис Apache Superset для визуализации данных и создать дашборд из не менее 5 различных визуализаций с аналитическими выводами.

В качестве источника данных используется аналитический слой DDS из ЛР2:
* **Фактовые таблицы**: `dds.fact_vacancy`, `dds.fact_employer_snapshot`
* **Измерения**: `dds.dim_date`, `dds.dim_area`, `dds.dim_employer`, `dds.dim_professional_role`, `dds.dim_industry`, `dds.dim_sphere`
* **Мостовые таблицы**: `dds.bridge_vacancy_professional_role`, `dds.bridge_vacancy_sphere`

## **Архитектура витрин данных (DM)**

### **Выбор структуры витрин**

Витрины данных (Data Marts) представляют собой агрегированные таблицы, оптимизированные для конкретных аналитических задач. Каждая витрина содержит предварительно вычисленные метрики и показатели, что позволяет ускорить выполнение аналитических запросов.

В рамках ЛР3 созданы **5 витрин данных**:

1. **dm.hh_top_employers_by_industry_region_currency** — топ‑20 работодателей по индустриям, регионам и валютам (по количеству вакансий и средней зарплате).
2. **dm.hh_industry_demand_trends_month** — тренды спроса по индустриям с расчётом месячных изменений (MoM — Month over Month).
3. **dm.hh_salary_by_industry_region_currency_month** — статистика по зарплатам (мин, средняя, макс) по индустриям, регионам, валютам и месяцам.
4. **dm.hh_regions_by_industry** — распределение вакансий по регионам в разрезе индустрий с расчётом долей и средней зарплаты.
5. **dm.hh_currency_structure_by_industry_region** — структура валют по индустриям и регионам с расчётом долей.

### **Описание витрин данных**

#### **1. dm.hh_top_employers_by_industry_region_currency**

**Назначение**: Определение топ‑20 работодателей в каждой комбинации индустрия/регион/валюта по количеству вакансий и средней зарплате.

**Структура**:
* `industry_id TEXT NOT NULL` — идентификатор индустрии (professional_role).
* `industry_name TEXT NOT NULL` — название индустрии.
* `area_id BIGINT` — идентификатор региона.
* `area_name TEXT` — название региона.
* `employer_id BIGINT NOT NULL` — идентификатор работодателя.
* `employer_name TEXT NOT NULL` — название работодателя.
* `currency TEXT NOT NULL` — валюта зарплаты.
* `vacancies_cnt INTEGER NOT NULL` — количество вакансий.
* `vacancies_with_salary_cnt INTEGER NOT NULL` — количество вакансий с указанной зарплатой.
* `salary_avg NUMERIC` — средняя зарплата.

**Первичный ключ**: `(industry_id, area_id, employer_id, currency)`

**Логика построения**:
* Для каждой вакансии определяется основная индустрия (MIN(role_id) из bridge_vacancy_professional_role).
* Вычисляется средняя зарплата как `(salary_from + salary_to) / 2` или `COALESCE(salary_from, salary_to)`.
* Выполняется агрегация по комбинации индустрия/регион/работодатель/валюта.
* Применяется ранжирование (ROW_NUMBER) по убыванию количества вакансий и средней зарплаты.
* Выбираются топ‑20 работодателей для каждой комбинации индустрия/регион/валюта.

#### **2. dm.hh_industry_demand_trends_month**

**Назначение**: Анализ динамики спроса на вакансии по индустриям с расчётом месячных изменений.

**Структура**:
* `month DATE NOT NULL` — месяц (первый день месяца).
* `industry_id TEXT NOT NULL` — идентификатор индустрии.
* `industry_name TEXT NOT NULL` — название индустрии.
* `vacancies_cnt INTEGER NOT NULL` — количество вакансий в месяце.
* `mom_abs INTEGER` — абсолютное изменение относительно предыдущего месяца (Month over Month).
* `mom_pct NUMERIC` — процентное изменение относительно предыдущего месяца.

**Первичный ключ**: `(month, industry_id)`

**Логика построения**:
* Группировка вакансий по месяцу публикации (`date_trunc('month', published_date)`) и индустрии.
* Подсчёт количества вакансий в каждом месяце.
* Расчёт MoM‑метрик с использованием оконной функции `LAG()`:
  * `mom_abs = vacancies_cnt - LAG(vacancies_cnt)`
  * `mom_pct = (vacancies_cnt / LAG(vacancies_cnt)) - 1`

#### **3. dm.hh_salary_by_industry_region_currency_month**

**Назначение**: Статистика по зарплатам в разрезе индустрий, регионов, валют и месяцев.

**Структура**:
* `month DATE NOT NULL` — месяц.
* `industry_id TEXT NOT NULL` — идентификатор индустрии.
* `industry_name TEXT NOT NULL` — название индустрии.
* `area_id BIGINT` — идентификатор региона.
* `area_name TEXT` — название региона.
* `currency TEXT NOT NULL` — валюта зарплаты.
* `vacancies_cnt INTEGER NOT NULL` — общее количество вакансий.
* `vacancies_with_salary_cnt INTEGER NOT NULL` — количество вакансий с указанной зарплатой.
* `salary_min NUMERIC` — минимальная зарплата.
* `salary_avg NUMERIC` — средняя зарплата.
* `salary_max NUMERIC` — максимальная зарплата.

**Первичный ключ**: `(month, industry_id, area_id, currency)`

**Логика построения**:
* Группировка вакансий по месяцу, индустрии, региону и валюте.
* Вычисление статистических показателей: MIN, AVG, MAX для зарплат.

#### **4. dm.hh_regions_by_industry**

**Назначение**: Анализ распределения вакансий по регионам в разрезе индустрий с расчётом долей и средней зарплаты.

**Структура**:
* `industry_id TEXT NOT NULL` — идентификатор индустрии.
* `industry_name TEXT NOT NULL` — название индустрии.
* `area_id BIGINT` — идентификатор региона.
* `area_name TEXT` — название региона.
* `vacancies_cnt INTEGER NOT NULL` — количество вакансий в регионе.
* `vacancies_with_salary_cnt INTEGER NOT NULL` — количество вакансий с указанной зарплатой.
* `share_in_industry NUMERIC` — доля вакансий региона в общей сумме по индустрии.
* `salary_avg NUMERIC` — средняя зарплата в регионе.

**Первичный ключ**: `(industry_id, area_id)`

**Логика построения**:
* Группировка вакансий по индустрии и региону.
* Расчёт доли региона: `vacancies_cnt / SUM(vacancies_cnt) OVER (PARTITION BY industry_id)`.

#### **5. dm.hh_currency_structure_by_industry_region**

**Назначение**: Анализ структуры валют зарплат по индустриям и регионам.

**Структура**:
* `industry_id TEXT NOT NULL` — идентификатор индустрии.
* `industry_name TEXT NOT NULL` — название индустрии.
* `area_id BIGINT` — идентификатор региона.
* `area_name TEXT` — название региона.
* `currency TEXT NOT NULL` — валюта зарплаты.
* `vacancies_cnt INTEGER NOT NULL` — количество вакансий с данной валютой.
* `currency_share NUMERIC` — доля валюты в общем количестве вакансий по индустрии и региону.

**Первичный ключ**: `(industry_id, area_id, currency)`

**Логика построения**:
* Группировка вакансий по индустрии, региону и валюте.
* Расчёт доли валюты: `vacancies_cnt / SUM(vacancies_cnt) OVER (PARTITION BY industry_id, area_id)`.

## **Реализация ETL‑процессов для витрин данных**

### **Общая архитектура**

Все витрины данных построены по единому принципу:
1. **Полный рефреш (Full Refresh)**: при каждом запуске витрина полностью очищается (TRUNCATE) и пересчитывается заново.
2. **Зависимости от DDS**: каждый DAG витрины ожидает завершения загрузки соответствующих данных в DDS через `ExternalTaskSensor`.
3. **Схема DM**: все витрины размещены в отдельной схеме `dm` в базе данных `postgres_dm`.

### **Утилиты для построения витрин**

Файл: `dags/hh_dm_utils.py`

Реализована функция `full_refresh_table()`, которая выполняет:
* Создание схемы `dm` (если не существует).
* Создание таблицы витрины (CREATE TABLE IF NOT EXISTS).
* Очистку таблицы (TRUNCATE).
* Выборку агрегированных данных из DDS (SELECT).
* Пакетную вставку данных в витрину (INSERT батчами по 2000 строк).

### **DAG'и для построения витрин**

#### **1. DAG hh_dm_top_employers_by_industry_region**

Файл: `dags/hh_dm_top_employers_by_industry_region.py`

**Структура DAG**:
* **Зависимость от DDS**:  
  Задача `wait_for_dds_vacancies_bridge` (ExternalTaskSensor) ожидает завершения задачи `load_bridge_vacancy_professional_role` в DAG `hh_vacancies_dds_postgres`.
* **Задача DAG**:  
  `build_mart` — построение витрины `dm.hh_top_employers_by_industry_region_currency`.
* **Расписание**: `*/10 * * * *` (каждые 10 минут).

**SQL‑логика построения**:
* Определение основной индустрии для каждой вакансии через `bridge_vacancy_professional_role`.
* Агрегация по комбинации индустрия/регион/работодатель/валюта.
* Ранжирование и выбор топ‑20 работодателей.

#### **2. DAG hh_dm_industry_demand_trends**

Файл: `dags/hh_dm_industry_demand_trends.py`

**Структура DAG**:
* **Зависимость от DDS**:  
  Задача `wait_for_dds_vacancies_bridge` ожидает завершения загрузки bridge‑таблицы.
* **Задача DAG**:  
  `build_mart` — построение витрины `dm.hh_industry_demand_trends_month`.
* **Расписание**: `*/10 * * * *` (каждые 10 минут).

**SQL‑логика построения**:
* Группировка вакансий по месяцу и индустрии.
* Расчёт MoM‑метрик с использованием оконной функции `LAG()`.

#### **3. DAG hh_dm_salary_by_industry_region_currency**

Файл: `dags/hh_dm_salary_by_industry_region_currency.py`

**Структура DAG**:
* **Зависимость от DDS**:  
  Задача `wait_for_dds_vacancies_bridge` ожидает завершения загрузки bridge‑таблицы.
* **Задача DAG**:  
  `build_mart` — построение витрины `dm.hh_salary_by_industry_region_currency_month`.
* **Расписание**: `*/10 * * * *` (каждые 10 минут).

**SQL‑логика построения**:
* Группировка вакансий по месяцу, индустрии, региону и валюте.
* Вычисление статистических показателей: MIN, AVG, MAX.

#### **4. DAG hh_dm_regions_by_industry**

Файл: `dags/hh_dm_regions_by_industry.py`

**Структура DAG**:
* **Зависимость от DDS**:  
  Задача `wait_for_dds_vacancies_bridge` ожидает завершения загрузки bridge‑таблицы.
* **Задача DAG**:  
  `build_mart` — построение витрины `dm.hh_regions_by_industry`.
* **Расписание**: `*/10 * * * *` (каждые 10 минут).

**SQL‑логика построения**:
* Группировка вакансий по индустрии и региону.
* Расчёт доли региона в общей сумме по индустрии.

#### **5. DAG hh_dm_currency_structure_by_industry_region**

Файл: `dags/hh_dm_currency_structure_by_industry_region.py`

**Структура DAG**:
* **Зависимость от DDS**:  
  Задача `wait_for_dds_vacancies_bridge` ожидает завершения загрузки bridge‑таблицы.
* **Задача DAG**:  
  `build_mart` — построение витрины `dm.hh_currency_structure_by_industry_region`.
* **Расписание**: `*/10 * * * *` (каждые 10 минут).

**SQL‑логика построения**:
* Группировка вакансий по индустрии, региону и валюте.
* Расчёт доли валюты в общем количестве вакансий по индустрии и региону.

### **Пример SQL для построения витрины**

Ниже приведён фрагмент SQL‑запроса для витрины `dm.hh_top_employers_by_industry_region_currency`:

```sql
WITH vmap AS (
    SELECT
        b.vacancy_id,
        MIN(r.role_id) AS industry_id
    FROM dds.bridge_vacancy_professional_role b
    JOIN dds.dim_professional_role r
      ON r.role_id = b.role_id
    GROUP BY b.vacancy_id
),
base AS (
    SELECT
        vmap.industry_id AS industry_id,
        r.role_name AS industry_name,
        f.area_id AS area_id,
        da.area_name AS area_name,
        de.employer_id AS employer_id,
        de.employer_name AS employer_name,
        COALESCE(NULLIF(f.salary_currency, ''), 'UNKNOWN') AS currency,
        CASE
            WHEN f.salary_from IS NOT NULL AND f.salary_to IS NOT NULL THEN (f.salary_from + f.salary_to) / 2
            ELSE COALESCE(f.salary_from, f.salary_to)
        END AS salary_point
    FROM dds.fact_vacancy f
    JOIN vmap
      ON vmap.vacancy_id = f.vacancy_id
    JOIN dds.dim_professional_role r
      ON r.role_id = vmap.industry_id
    LEFT JOIN dds.dim_area da
      ON da.area_id = f.area_id
    JOIN dds.dim_employer de
      ON de.employer_sk = f.employer_sk
     AND de.is_current = TRUE
),
agg AS (
    SELECT
        industry_id,
        industry_name,
        area_id,
        area_name,
        employer_id,
        employer_name,
        currency,
        COUNT(*)::int AS vacancies_cnt,
        COUNT(*) FILTER (WHERE salary_point IS NOT NULL)::int AS vacancies_with_salary_cnt,
        AVG(salary_point) AS salary_avg
    FROM base
    GROUP BY
        industry_id,
        industry_name,
        area_id,
        area_name,
        employer_id,
        employer_name,
        currency
),
ranked AS (
    SELECT
        a.*,
        ROW_NUMBER() OVER (
            PARTITION BY a.industry_id, a.area_id, a.currency
            ORDER BY a.vacancies_cnt DESC, a.salary_avg DESC NULLS LAST
        ) AS rn
    FROM agg a
)
SELECT
    industry_id,
    industry_name,
    area_id,
    area_name,
    employer_id,
    employer_name,
    currency,
    vacancies_cnt,
    vacancies_with_salary_cnt,
    salary_avg
FROM ranked
WHERE rn <= 20;
```

## **Развертывание Apache Superset**

### **Конфигурация в docker-compose**

В файле `docker-compose.yaml` добавлены сервисы для развертывания Apache Superset:

**Сервисы**:
1. **superset_db** — база данных PostgreSQL для метаданных Superset.
2. **superset** — основной сервис Superset (веб‑интерфейс на порту 8088).
3. **superset-init** — сервис инициализации Superset (создание администратора и загрузка визуализаций).

**Конфигурация**:
* Версия образа: `apache/superset:3.1.0`
* Порт: `8088`
* Администратор: `admin / admin`
* Подключение к базе данных витрин: через переменную окружения `LAB3_DM_SQLALCHEMY_URI` (по умолчанию `postgresql+psycopg2://airflow:airflow@postgres_dm:5432/dm_hh`)

**Volumes**:
* `superset/superset_config.py` — конфигурация Superset.
* `superset/charts/` — директория с JSON‑файлами описания визуализаций.
* `superset/bootstrap_lab3_charts.py` — скрипт для автоматического создания визуализаций.

### **Скрипт инициализации визуализаций**

Файл: `superset/bootstrap_lab3_charts.py`

Скрипт автоматически создаёт:
* Подключение к базе данных витрин (Database).
* Наборы данных (Datasets) для каждой витрины.
* Визуализации (Charts) на основе JSON‑файлов из директории `charts/`.

**Логика работы**:
1. Создание или обновление подключения к базе данных.
2. Для каждого JSON‑файла из `charts/lab3_*.json`:
   * Создание или обновление набора данных.
   * Создание или обновление визуализации с параметрами из JSON.

## **Визуализации в Superset**

### **Описание визуализаций**

Создано **5 визуализаций**, каждая из которых решает конкретную аналитическую задачу:

#### **1. LAB3: Top employers by role/region/currency (Table)**

**Тип**: Таблица  
**Источник данных**: `dm.hh_top_employers_by_industry_region_currency`

**Назначение**: Отображение топ‑20 работодателей по каждой комбинации индустрия/регион/валюта с сортировкой по количеству вакансий.

**Поля**:
* `industry_name` — название индустрии.
* `area_name` — название региона.
* `currency` — валюта зарплаты.
* `employer_name` — название работодателя.
* `vacancies_cnt` — количество вакансий.
* `salary_avg` — средняя зарплата.

**Аналитический вывод**: Позволяет определить наиболее активных работодателей в каждой индустрии и регионе, а также сравнить средние зарплаты.

#### **2. LAB3: Demand trends by role (monthly) (Line Chart)**

**Тип**: Линейный график  
**Источник данных**: `dm.hh_industry_demand_trends_month`

**Назначение**: Визуализация динамики спроса на вакансии по индустриям с течением времени.

**Параметры**:
* Ось X: `month` (месяц).
* Ось Y: `SUM(vacancies_cnt)` (суммарное количество вакансий).
* Группировка: `industry_name` (каждая линия — отдельная индустрия).

**Аналитический вывод**: Позволяет выявить тренды роста или падения спроса на специалистов в различных индустриях, определить сезонность и пики активности.

#### **3. LAB3: Avg salary by role and currency (Bar Chart)**

**Тип**: Группированная столбчатая диаграмма  
**Источник данных**: `dm.hh_salary_by_industry_region_currency_month`

**Назначение**: Сравнение средних зарплат по индустриям с разбивкой по валютам.

**Параметры**:
* Ось X: `industry_name` (индустрия).
* Ось Y: `AVG(salary_avg)` (средняя зарплата).
* Группировка: `currency` (каждый столбец разбит по валютам).

**Аналитический вывод**: Позволяет сравнить уровень оплаты труда в разных индустриях и определить, в каких валютах преимущественно указываются зарплаты.

#### **4. LAB3: Regions by role (heatmap) (Heatmap)**

**Тип**: Тепловая карта  
**Источник данных**: `dm.hh_regions_by_industry`

**Назначение**: Визуализация распределения вакансий по регионам и индустриям.

**Параметры**:
* Ось X: `industry_name` (индустрия).
* Ось Y: `area_name` (регион).
* Интенсивность цвета: `SUM(vacancies_cnt)` (количество вакансий).

**Аналитический вывод**: Позволяет выявить регионы с наибольшей концентрацией вакансий в каждой индустрии, определить географические центры притяжения специалистов.

#### **5. LAB3: Currency structure by role (stacked) (Stacked Bar Chart)**

**Тип**: Сложенная столбчатая диаграмма  
**Источник данных**: `dm.hh_currency_structure_by_industry_region`

**Назначение**: Визуализация структуры валют зарплат по индустриям.

**Параметры**:
* Ось X: `industry_name` (индустрия).
* Ось Y: `SUM(vacancies_cnt)` (количество вакансий).
* Группировка: `currency` (каждый столбец разбит по валютам, показывая долю каждой валюты).

**Аналитический вывод**: Позволяет определить, в каких валютах преимущественно указываются зарплаты в каждой индустрии, выявить доминирующие валюты.

### **Аргументация выбора типов визуализаций**

1. **Table (Таблица)**: Выбрана для детального просмотра топ‑20 работодателей с возможностью сортировки и фильтрации. Позволяет аналитику получить точные значения метрик.

2. **Line Chart (Линейный график)**: Оптимален для отображения временных рядов и трендов. Позволяет легко выявить рост или падение спроса на вакансии по индустриям.

3. **Bar Chart (Столбчатая диаграмма)**: Эффективен для сравнения категориальных данных (индустрии) с разбивкой по подкатегориям (валюты). Позволяет быстро сравнить уровни зарплат.

4. **Heatmap (Тепловая карта)**: Идеальна для визуализации двумерных матриц (регионы × индустрии). Позволяет быстро выявить "горячие точки" концентрации вакансий.

5. **Stacked Bar Chart (Сложенная столбчатая диаграмма)**: Подходит для отображения структуры (доли валют) в каждой категории. Позволяет увидеть как общее количество, так и пропорции.

## **Аналитические выводы на основе визуализаций**

На основе созданных визуализаций можно сделать следующие выводы:

1. **Топ работодатели**: В каждой индустрии и регионе есть лидеры по количеству вакансий. Это позволяет HR‑специалистам и соискателям определить наиболее активных работодателей.

2. **Динамика спроса**: Линейный график трендов показывает сезонность в найме (например, пики активности весной и осенью) и изменения спроса на специалистов в различных индустриях.

3. **Уровень зарплат**: Столбчатая диаграмма позволяет сравнить средние зарплаты между индустриями и определить, в каких валютах преимущественно указываются зарплаты (RUB, USD, EUR).

4. **Географическое распределение**: Тепловая карта показывает концентрацию вакансий по регионам. Как правило, наибольшая активность наблюдается в Москве, Санкт‑Петербурге и крупных региональных центрах.

5. **Структура валют**: Сложенная столбчатая диаграмма демонстрирует, что в большинстве индустрий доминирует рубль, однако в IT и финансах значительная доля вакансий указывает зарплаты в долларах или евро.

## **Сводная таблица DAG'ов проекта**

| DAG ID | Файл | Расписание | Назначение |
| :---- | :---- | :---- | :---- |
| hh_vacancies_to_postgres | hh_ods_vacancies.py | 0 \*/6 \* \* \* | ODS: вакансии → PostgreSQL |
| hh_employers_to_postgres | hh_ods_employers.py | 0 \*/6 \* \* \* | ODS: работодатели → PostgreSQL |
| hh_salary_industries_to_postgres | hh_ods_salary_industries.py | 0 \*/6 \* \* \* | ODS: отрасли → PostgreSQL |
| hh_vacancies_dds_postgres | hh_dds_vacancies_postgres.py | 30 \*/6 \* \* \* | DDS: вакансии (dim\_date, dim\_area, dim\_employer, fact\_vacancy) |
| hh_employers_dds_postgres | hh_dds_employers_postgres.py | 15 \*/6 \* \* \* | DDS: работодатели (dim\_employer, fact\_employer\_snapshot) |
| hh_salary_industries_dds_postgres | hh_dds_salary_industries_postgres.py | 0 \*/12 \* \* \* | DDS: отрасли/сферы (dim\_industry, dim\_sphere) |
| hh_vacancies_dds_data_quality_postgres | hh_dds_data_quality_postgres.py | 45 \*/6 \* \* \* | Data Quality: проверки качества DDS |
| hh_dm_top_employers_by_industry_region | hh_dm_top_employers_by_industry_region.py | \*/10 \* \* \* \* | DM: топ‑20 работодателей |
| hh_dm_industry_demand_trends | hh_dm_industry_demand_trends.py | \*/10 \* \* \* \* | DM: тренды спроса по индустриям |
| hh_dm_salary_by_industry_region_currency | hh_dm_salary_by_industry_region_currency.py | \*/10 \* \* \* \* | DM: зарплаты по индустриям/регионам/валютам |
| hh_dm_regions_by_industry | hh_dm_regions_by_industry.py | \*/10 \* \* \* \* | DM: регионы по индустриям |
| hh_dm_currency_structure_by_industry_region | hh_dm_currency_structure_by_industry_region.py | \*/10 \* \* \* \* | DM: структура валют |

## **Заключение**

В рамках ЛР3 на основе аналитического слоя DDS из ЛР2 были построены **5 витрин данных** (Data Marts), оптимизированных для конкретных аналитических задач:

* Топ работодателей по индустриям, регионам и валютам.
* Тренды спроса на вакансии по индустриям с расчётом месячных изменений.
* Статистика по зарплатам в разрезе индустрий, регионов, валют и месяцев.
* Распределение вакансий по регионам в разрезе индустрий.
* Структура валют зарплат по индустриям и регионам.

В Apache Airflow реализованы **5 DAG'ов** для построения витрин, каждый из которых:
* Зависит от соответствующих DAG'ов DDS через `ExternalTaskSensor`.
* Выполняет полный рефреш витрины при каждом запуске.
* Использует единую утилиту `full_refresh_table()` для упрощения кода.

Развернут сервис **Apache Superset** для визуализации данных с автоматической инициализацией через скрипт `bootstrap_lab3_charts.py`.

Создан **дашборд из 5 визуализаций**:
* Таблица топ‑20 работодателей.
* Линейный график трендов спроса.
* Столбчатая диаграмма средних зарплат.
* Тепловая карта распределения по регионам.
* Сложенная столбчатая диаграмма структуры валют.

Каждая визуализация решает конкретную аналитическую задачу и позволяет делать выводы о рынке труда: определять лидеров по найму, анализировать динамику спроса, сравнивать уровни зарплат и выявлять географические закономерности.

